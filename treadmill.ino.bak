#include "MyThread.h"
#include "MyThreadController.h"

#include "Display.h"


#define KILL       0
#define START_STOP 1
#define DEC        2
#define INC        3
#define MODE       4

#define SCAN_MODE  0
#define SPEED_MODE 1
#define TIME_MODE  2
#define DIST_MODE  3
#define CAL_MODE   4

#define BUZZER            A5

//TODO 
#define TREADMILL    24

MyThreadController threadController = MyThreadController();

MyThread readStartStopThread = MyThread();
MyThread safeThread = MyThread();
MyThread countDownThread = MyThread();
MyThread modeThread = MyThread();
MyThread scanThread = MyThread();
MyThread updateStatusThread = MyThread();

static int ledPins[] = { SCAN_LED, SPEED_LED, TIME_LED, DIST_LED, CAL_LED };
static int digitPins[] = { DIGIT1, DIGIT2, DIGIT3, DIGIT4 };
static int segmentPins[] = { TOP, TOPRIGHT, BOTTOMRIGHT, BOTTOM, BOTTOMLEFT, TOPLEFT, MIDDLE, DECIMAL };
  
int countDownCounter = 3;

boolean running = false;
boolean safe = false;
int mode = SPEED_MODE;
boolean scanning = false;
char *status;

boolean vals[] = { false, false, false, false, false };

Display display = Display(digitPins, ledPins, segmentPins, LEDS);
MyThread refreshDisplayThread = MyThread();

Treadmill treadmill = Treadmill(TREADMILL);
MyThread refreshTreadmillThread = MyThread();

void initializeThread(MyThread* thread, void (*callback)(void), unsigned long _interval) {
  thread->onRun(callback);
  thread->setInterval(_interval);
  threadController.add(thread);
}

void _setSafeDigits() {
  setChar(0, '-', true);
  setChar(1, '-', true);
  setChar(2, '-', true);
  setChar(3, '-', true);
}

void countDown() {
  setChars("   " + (String)countDownCounter, vals);
  countDownCounter--;
  if (countDownCounter == 0) {
    running = true;
    requestedSpeed = 1.0;
    mode = SPEED_MODE;
    countDownThread.enabled = false;
  }
}

void start() {
  if (safe) {
    if (running) return;
    if (safe) {
      countDownCounter = 3;
      countDownThread.enabled = true;
    }
  }
}

void stop() {
  if (safe) {
    _setSafeDigits();
  }
  running = false;
  requestedSpeed = 0.0;
}

void kill_unsafe() {
  safe = false;
  setChars("SAFE", vals);
  stop();
}
void kill_safe() {
  safe = true;
  if ( !running ) {
    _setSafeDigits();
  }
}
void readKill() {
  readSwitch(KILL, kill_safe, kill_unsafe);
}

int wifiCommand(String command) {
  if ( command == "START" )
    startStop();

  if ( command == "STOP" )
    startStop();

  if ( command == "INC" )
    if ( safe && running ) 
      inc();

  if ( command == "DEC" )
    if ( safe && running ) 
      dec();

  if ( command == "MODE" )
    if ( safe && running ) 
      changeMode();

  return 1;
}

void setup() {
  pinMode(BUZZER, OUTPUT);
  digitalWrite(BUZZER, HIGH);

//   safe = false;
   
  initializeThread(&refreshDisplayThread, display.refresh, 5);
  initializeThread(&refreshTreadmillThread, treadmill.refresh, 1);

  initializeThread(&readStartStopThread, readStartStop, 5);
  initializeThread(&safeThread, readKill, 5);
  initializeThread(&countDownThread, countDown, 1000);
  initializeThread(&scanThread, scan, 3000);
  initializeThread(&updateStatusThread, updateStatus, 10);

  Particle.function("wifiCommand", wifiCommand);
  updateStatus();
  Particle.variable("status", status, STRING);
}

void loop() {
  threadController.run();
}

void main_loop() {
  if ( !safe ) {
    setChars("SAFE", vals);
    stop();
  } else {
    if ( !running) {
      _setSafeDigits();
    } 
  }
} 

void display() {
  _displayMode();
  _displaySpeed();  
}

void _displayMode() {
  for (int i = 0; i < 5; i++)
    setLed(ledPins[i], false);
  setLed(ledPins[SCAN_MODE], scanning);
  setLed(ledPins[mode], true);
}

//TODO fixme
void _displaySpeed() {
//  setChars(printf( "%4s", printf( "%2f", speed )), vals);
  setChars("PEED", vals);
}

void scan() {
  if (safe && running && scanning)
    mode = (mode % 4) + 1;
}

// FIXME
int calories() {
  return 4;
}
int time() {
  return 5;
}
int distance() {
  return 6;
}
void updateStatus() {
  status = (char*)millis();
//  status =
//    printf(
//      "{ \"speed\":%f, \"calories\":%d, \"time\":%d, \"distance\":%d }",
//      speed, calories(), time(), distance() );
}

// display
// refreshSegments
// refreshLeds
// readStartStop
// readInc
// readDec
// readMode
// setSpeed
// kill
// scan
// updateStatus
